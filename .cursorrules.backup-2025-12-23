# Cursor AI Rules - Platform Roadmap Manager

## Project Overview
Platform Roadmap Manager - A multi-workspace roadmap planning application with AI-powered features, real-time Supabase sync, and Vercel deployment.

**Tech Stack**:
- Framework: Next.js 15 + TypeScript (App Router, Server Components)
- Database: Supabase (PostgreSQL + Real-time + Auth)
- UI: shadcn/ui + Tailwind CSS + Lucide React
- Mind Mapping: ReactFlow
- Charts: Recharts
- Testing: Playwright (E2E) + Jest (Unit)
- Payments: Stripe
- Email: Resend
- Deployment: Vercel
- MCP Servers: 5 active (Supabase, Playwright, Parallel-search, Parallel-Task, Vercel)

**Live URL**: https://platform-test-cyan.vercel.app

---

## Architecture Principles

### Multi-Workspace System
- **Workspace isolation**: All data must filter by `workspace_id`
- **User scope**: Currently single-user (`user_id = 'default'`)
- **ID format**: Timestamp-based strings (`Date.now().toString()`) - NEVER use UUID
- **Workspace properties**: id, name, description, color (hex), icon (emoji), customInstructions, aiMemory
- **No cross-workspace references**: Features, timeline items, and links stay within workspace boundaries

### Database Schema (Supabase)
**Primary Tables**:
- `workspaces` - Workspace metadata and AI settings
- `features` - Top-level roadmap items with `workspace_id` foreign key
- `timeline_items` - Nested items with `feature_id` and timeline (MVP/SHORT/LONG)
- `linked_items` - Bidirectional relationships between timeline items
- `user_settings` - Global user preferences

**Key Constraints**:
- All tables have `user_id` and `workspace_id` columns
- RLS policies enabled (user + workspace filtering)
- Timestamps: `created_at`, `updated_at` (auto-managed)
- Soft deletes preferred over hard deletes

### Data Sync Strategy
1. **Write**: Save to localStorage immediately â†’ Async sync to Supabase
2. **Read**: Load from Supabase â†’ Cache in localStorage
3. **Real-time**: Subscribe to Supabase changes for cross-browser sync
4. **Conflict resolution**: Last write wins (timestamp-based)

---

## Coding Standards

### TypeScript Style
```typescript
// âœ… GOOD: Strict typing, interfaces, modern syntax
interface CreateWorkspaceParams {
  name: string;
  description: string;
  teamId: string;
}

const createWorkspace = async ({ name, description, teamId }: CreateWorkspaceParams): Promise<Workspace> => {
  const workspace: Workspace = {
    id: Date.now().toString(),  // Timestamp ID
    teamId,
    name,
    description,
    phase: 'research',
    color: '#3B82F6',
    icon: 'ðŸ“Š',
    enabledModules: ['research', 'mind_map', 'features'],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  return workspace;
};

// âŒ BAD: any types, unclear parameter objects, UUID
const createWorkspace = async (data: any) => {
  const w: any = { id: generateUUID(), ...data };
  return w;
};
```

### Database Queries
```javascript
// âœ… GOOD: Workspace-scoped, error handling
const loadFeatures = async (workspaceId) => {
    try {
        const { data, error } = await supabase
            .from('features')
            .select('*')
            .eq('user_id', 'default')
            .eq('workspace_id', workspaceId)  // REQUIRED
            .order('created_at', { ascending: false });

        if (error) throw error;
        return data || [];
    } catch (err) {
        console.error('Failed to load features:', err);
        return [];
    }
};

// âŒ BAD: No workspace filter, no error handling
const loadFeatures = async () => {
    const { data } = await supabase.from('features').select('*');
    return data;
};
```

### React/Next.js Components
```tsx
// âœ… GOOD: TypeScript, shadcn/ui, accessible
import { Card, CardHeader, CardTitle, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

interface WorkspaceCardProps {
  workspace: Workspace;
  onEdit: (id: string) => void;
}

export function WorkspaceCard({ workspace, onEdit }: WorkspaceCardProps) {
  return (
    <Card className="workspace-card" data-workspace-id={workspace.id}>
      <CardHeader>
        <div className="flex items-center gap-2">
          <span className="text-2xl" role="img" aria-label="Workspace icon">
            {workspace.icon}
          </span>
          <CardTitle>{workspace.name}</CardTitle>
        </div>
        <CardDescription>{workspace.description}</CardDescription>
      </CardHeader>
      <CardFooter>
        <Button onClick={() => onEdit(workspace.id)} aria-label="Edit workspace">
          Edit
        </Button>
      </CardFooter>
    </Card>
  );
}

// âŒ BAD: No types, inline styles, poor accessibility
const WorkspaceCard = ({ workspace, onEdit }) => (
  <div style={{ padding: '10px' }} onClick={onEdit}>
    <span>{workspace.icon}</span>
    <div>{workspace.name}</div>
  </div>
);
```

---

## MCP Server Usage (Optimized for Next.js 15 + TypeScript)

### Active MCPs (5 Total - Enhanced Automation & Search)

**Supabase MCP** (Essential) - Use for:
- Multi-tenant schema design (`teams`, `workspaces`, `features`, `mind_maps`)
- Database migrations with RLS policies
- Complex queries (joins, aggregations, transactions)
- Real-time subscriptions setup
- PostgreSQL functions and triggers
- Schema inspection and type generation
- Running SQL scripts for data migrations

**Playwright MCP** (Testing) - Use for:
- E2E testing Next.js pages and API routes
- User authentication flow tests
- Feature CRUD operation tests
- Mind map canvas interaction tests
- Stripe payment flow tests (test mode)
- Screenshot capture for documentation
- CI/CD integration (GitHub Actions)

**Parallel-search MCP** (AI Research) - Use for:
- Multi-source web search (Tavily, Perplexity, Exa, Brave)
- Competitive analysis and market research
- AI-powered content discovery and trend analysis
- Knowledge base population with web sources
- Semantic search across multiple engines
- Real-time information gathering for AI features

**Parallel-Task MCP** (Automation) - Use for:
- Multi-agent task orchestration and workflows
- Parallel execution of complex development tasks
- Task dependency management and coordination
- Automated testing and deployment pipelines
- Multi-step workflow automation (migration + build + deploy)
- CI/CD pipeline integration and orchestration

**Vercel MCP** (Deployment) - Use for:
- Production and preview deployments
- Environment variable management (Supabase keys, Stripe keys, OpenRouter API)
- Build logs and error debugging
- Performance monitoring and analytics
- Custom domain configuration and SSL
- Deployment orchestration with Parallel-Task MCP

### Removed MCPs (Context Savings)

- âŒ **Puppeteer** - Redundant with Playwright
- âŒ **Browser Tools** - Use Chrome DevTools instead
- âŒ **21st Magic** - Using shadcn/ui, not generating components
- âŒ **MCP-UI** - Not needed for Next.js + shadcn/ui
- âŒ **Exa** - Redundant with Parallel-search MCP (which includes Exa + Tavily + Perplexity + Brave)

### MCP Usage Examples

```plaintext
// Multi-Tenant Schema
"Create migrations for mind_maps, mind_map_nodes, and mind_map_edges tables with team_id and RLS policies"
â†’ Supabase MCP creates migrations, applies RLS policies

// Real-time Setup
"Set up Supabase Realtime subscriptions for workspace changes with proper filtering by team_id"
â†’ Supabase MCP configures real-time, provides TypeScript client code

// Deployment
"Deploy to production and verify environment variables are set correctly"
â†’ Vercel MCP builds, deploys, checks env vars

// E2E Testing
"Create Playwright tests for authentication flow, team creation, and feature CRUD"
â†’ Playwright MCP generates test suite with proper selectors

// Performance Query
"Optimize the query for loading features with timeline_items and linked_items"
â†’ Supabase MCP analyzes query, suggests indexes, provides optimized SQL

// AI Research
"Search for best practices in product roadmap management and mind mapping UX patterns"
â†’ Parallel-search MCP queries multiple engines, aggregates results

// Task Automation
"Orchestrate workflow: apply migration â†’ build Next.js app â†’ run tests â†’ deploy to Vercel"
â†’ Parallel-Task MCP coordinates multi-step workflow with proper dependencies
```

---

## Common Patterns

### Adding New Fields to Features

**1. Update Data Model**:
```javascript
// In feature creation logic
const feature = {
    // ... existing fields
    newField: value  // Add new field
};
```

**2. Create Migration**:
```sql
-- supabase/migrations/20250111_add_new_field.sql
ALTER TABLE features ADD COLUMN IF NOT EXISTS new_field TEXT;
CREATE INDEX IF NOT EXISTS idx_features_new_field ON features(new_field);
UPDATE features SET new_field = 'default' WHERE new_field IS NULL;
```

**3. Update Sync Method**:
```javascript
// In supabaseService.js
const featuresData = features.map(f => ({
    // ... existing mappings
    new_field: f.newField  // camelCase â†’ snake_case
}));
```

**4. Update Export/Import**:
```javascript
// Ensure new field is included in backup JSON
```

### Creating Workspace-Scoped Features

**Always include workspace context**:
```javascript
// âœ… Correct
const createFeature = (title, description) => {
    if (!this.currentWorkspaceId) {
        throw new Error('No active workspace');
    }

    const feature = {
        id: Date.now().toString(),
        workspaceId: this.currentWorkspaceId,  // REQUIRED
        title,
        description,
        timelineItems: [],
        createdAt: new Date().toISOString()
    };

    return feature;
};

// âŒ Wrong - no workspace assignment
const createFeature = (title, description) => {
    return { id: Date.now().toString(), title, description };
};
```

### Bidirectional Link Creation

**Always maintain both directions**:
```javascript
const createLink = (sourceItemId, targetItemId, relationshipType) => {
    const links = [
        {
            id: Date.now().toString(),
            sourceItemId,
            targetItemId,
            relationshipType,  // 'dependency' or 'complements'
            direction: 'outgoing'
        },
        {
            id: (Date.now() + 1).toString(),
            sourceItemId: targetItemId,
            targetItemId: sourceItemId,
            relationshipType,
            direction: 'incoming'  // Reverse direction
        }
    ];

    return links;
};
```

---

## Testing Guidelines

### Before Committing

1. **Manual Testing**:
   - Test in actual browser (not just DevTools)
   - Try with multiple workspaces
   - Verify Supabase sync works
   - Check localStorage cache

2. **Automated Testing**:
   ```plaintext
   "Run Playwright tests for workspace CRUD operations"
   ```

3. **Data Integrity**:
   - Verify no orphaned features (features without workspace_id)
   - Check bidirectional links are maintained
   - Confirm timestamps are ISO 8601 format

### Common Test Scenarios

```plaintext
1. Create workspace â†’ Add features â†’ Switch workspace â†’ Verify isolation
2. Create link â†’ Check both directions exist â†’ Delete link â†’ Verify cleanup
3. Export data â†’ Import in fresh browser â†’ Verify all data restored
4. Real-time: Open two browser tabs â†’ Edit in one â†’ Verify sync in other
```

---

## Performance Optimization

### Database Queries
- **Index frequently filtered columns**: `workspace_id`, `user_id`, `created_at`
- **Batch operations**: Use Supabase batch insert/update when possible
- **Limit data**: Don't load all workspaces if only using one

### Frontend
- **Lazy load**: Load features only when workspace is selected
- **Debounce saves**: Don't save on every keystroke (300ms debounce)
- **Cache smartly**: Use localStorage to reduce API calls

### Supabase Real-time
- **Subscribe selectively**: Only subscribe to current workspace's changes
- **Unsubscribe on switch**: Clean up subscriptions when switching workspaces

---

## Security Considerations

### API Keys
- **Never commit**: API keys in `.env` files (already in `.gitignore`)
- **Use anon key**: Client-side uses Supabase anon key only
- **Service role key**: Only for backend/migration scripts (not in browser)

### Data Validation
```javascript
// âœ… Validate user input
const createWorkspace = (name, description) => {
    if (!name || name.trim().length === 0) {
        throw new Error('Workspace name is required');
    }
    if (name.length > 100) {
        throw new Error('Workspace name too long (max 100 chars)');
    }
    // ... create workspace
};
```

### SQL Injection Prevention
- **Use parameterized queries**: Supabase client handles this automatically
- **Never concatenate user input into SQL strings**

---

## Deployment Workflow

### Standard Process
```bash
# 1. Test locally
npm install
# Open index.html in browser

# 2. Apply migrations (if any)
npx supabase db push

# 3. Commit changes
git add .
git commit -m "feat: add priority field to features"
git push origin main

# 4. Deploy to Vercel
vercel --prod

# 5. Verify production
# Visit https://platform-test-cyan.vercel.app
```

### Using Vercel MCP
```plaintext
You: "Deploy to production and check if the build succeeded"
Cursor: [Uses Vercel MCP to deploy, monitors logs, reports status]
```

---

## Error Handling

### Supabase Errors
```javascript
try {
    const { data, error } = await supabase
        .from('features')
        .insert(featureData);

    if (error) {
        // Log full error for debugging
        console.error('Supabase error:', error);

        // Show user-friendly message
        showNotification('Failed to save feature. Please try again.', 'error');
        return null;
    }

    return data;
} catch (err) {
    console.error('Unexpected error:', err);
    showNotification('An unexpected error occurred.', 'error');
    return null;
}
```

### Network Failures
```javascript
const syncWithRetry = async (data, maxRetries = 3) => {
    for (let i = 0; i < maxRetries; i++) {
        try {
            await supabaseService.syncData(data);
            return true;
        } catch (err) {
            console.warn(`Sync attempt ${i + 1} failed:`, err);
            if (i === maxRetries - 1) {
                showNotification('Sync failed. Data saved locally.', 'warning');
                return false;
            }
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
};
```

---

## AI Assistant Behavior

### When Using MCPs
- **Prefer MCP tools** over manual file editing for database/deployment tasks
- **Use Supabase MCP** for all SQL operations, migrations, and RLS policies
- **Use Vercel MCP** for deployments, environment variables, and monitoring
- **Use Playwright MCP** for E2E testing and user flow validation
- **Use shadcn/ui** for UI components (not external generation tools)

### Code Generation Preferences
- **TypeScript Strict Mode**: Always use explicit types, avoid `any`, prefer `unknown`
- **Next.js 15 Best Practices**: App Router, Server Components (RSC), Server Actions
- **shadcn/ui Components**: Use pre-built components from shadcn/ui library
- **Tailwind CSS**: Utility-first styling, avoid custom CSS files
- **Accessibility-first**: ARIA labels, semantic HTML, keyboard navigation
- **Mobile-responsive**: Mobile-first design with Tailwind breakpoints

### Documentation
- **Comment complex logic**: Especially AI-related algorithms
- **Update CLAUDE.md**: When architecture changes
- **Migration comments**: Explain WHY, not just WHAT
- **Inline JSDoc**: For public functions

---

## Quick Reference

### File Structure
```
Platform Test/
â”œâ”€â”€ index.html              # Main application UI
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ variables.css       # CSS custom properties (colors, spacing)
â”‚   â”œâ”€â”€ base.css           # Reset and base styles
â”‚   â”œâ”€â”€ components.css     # Reusable component styles
â”‚   â””â”€â”€ views.css          # View-specific styles
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ supabase.js    # Supabase client and sync logic
â”‚   â”‚   â”œâ”€â”€ ai-service.js  # AI integration (Claude/GPT)
â”‚   â”‚   â””â”€â”€ search-orchestrator.js  # Search functionality
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ sample-data.js # Sample workspace/feature data
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/        # Database migration SQL files
â”œâ”€â”€ mcp-ui-server.js       # Custom MCP server
â”œâ”€â”€ CLAUDE.md              # Project guidelines (YOU ARE HERE)
â”œâ”€â”€ CURSOR_SETUP_GUIDE.md  # Cursor MCP setup instructions
â””â”€â”€ .cursorrules           # Cursor AI behavior rules
```

### Important Constants
```javascript
USER_ID = 'default'                    // Single-user mode
TIMELINE_TYPES = ['MVP', 'SHORT', 'LONG']
RELATIONSHIP_TYPES = ['dependency', 'complements']
DIRECTIONS = ['incoming', 'outgoing']
```

### Color Palette (CSS Variables)
```css
--primary-blue: #3B82F6
--primary-dark: #1E40AF
--success-green: #10B981
--warning-yellow: #F59E0B
--danger-red: #EF4444
--neutral-gray: #6B7280
```

---

## Troubleshooting Common Issues

### Features Not Showing After Workspace Switch
**Cause**: Features not filtered by `workspace_id`
**Fix**: Ensure all queries include `.eq('workspace_id', currentWorkspaceId)`

### Import Fails with "Invalid Data"
**Cause**: Backup JSON missing `version` field or wrong structure
**Fix**: Check backup has `{ version: '2.0', workspaces: [...], features: [...] }`

### Supabase Sync Fails Silently
**Cause**: RLS policies blocking inserts, or network issues
**Fix**: Check browser console, verify Supabase project is active

### Duplicate Links Created
**Cause**: Bidirectional links not checked before creation
**Fix**: Check if link exists before creating (both directions)

### Workspace Selector Empty
**Cause**: No workspaces in database, or failed to load
**Fix**: Run `migrate_existing_data.sql` or create first workspace

---

## Version History

- **v2.0** (2025-01-11): Multi-workspace support, Supabase sync, MCP integration
- **v1.0** (2024): Initial single-workspace localStorage-only version

---

**Last Updated**: 2025-01-11
**Cursor Setup Guide**: [CURSOR_SETUP_GUIDE.md](CURSOR_SETUP_GUIDE.md)
**Main Guidelines**: [CLAUDE.md](CLAUDE.md)
