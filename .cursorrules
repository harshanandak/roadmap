# Cursor AI Rules - Product Lifecycle Management Platform

**Last Updated**: 2025-12-23
**Project**: Product Lifecycle Management Platform
**Tech Stack**: Next.js 15 + TypeScript + Supabase + Vercel
**Status**: Week 7/12 (95% complete)

---

## ğŸ¯ Project Overview

Transform roadmap manager into **Product Lifecycle Management Platform** with:
1. **Research & Ideate** - AI-powered mind mapping, web search, knowledge base
2. **Plan & Structure** - Features, timeline, dependencies
3. **Review & Gather Feedback** - Stakeholder input (invite-based, public links)
4. **Execute Collaboratively** - Team assignment, task tracking, real-time collaboration
5. **Test & Iterate** - User feedback collection and analysis
6. **Measure Success** - Analytics, expected vs actual performance tracking

**Live URL**: https://platform-test-cyan.vercel.app

**Canonical Reference**: `docs/ARCHITECTURE_CONSOLIDATION.md` is the single source of truth

---

## ğŸ›ï¸ Architecture Principles

### Multi-Tenant System (CRITICAL)

- **Team Isolation**: ALL data must filter by `team_id` (NOT workspace_id)
- **ID Format**: Timestamp-based TEXT IDs (`Date.now().toString()`) - NEVER use UUID
- **Row-Level Security**: RLS policies enforce access control on all tables
- **Workspace = Project**: Each workspace is a separate product/project within a team

**Critical Rule**: `team_id` must NEVER be NULL (breaks RLS silently with empty `{}` errors)

```typescript
// âœ… CORRECT - Always filter by team_id
const { data } = await supabase
  .from('work_items')
  .select('*')
  .eq('team_id', teamId)
  .order('created_at', { ascending: false })

// âŒ WRONG - Missing team_id filter
const { data } = await supabase
  .from('work_items')
  .select('*')
```

### Two-Layer System (NOT Three)

```
WORKSPACE (Aggregation View)
â”œâ”€â”€ mode: development | launch | growth | maintenance
â”œâ”€â”€ Shows: Phase DISTRIBUTION across all work items
â”‚   Example: "5 features in build, 2 bugs in triage, 1 concept in research..."
â”‚
â””â”€â”€ WORK ITEMS (Each has own type-specific phase)
    â”œâ”€â”€ Feature/Enhancement: design â†’ build â†’ refine â†’ launch
    â”œâ”€â”€ Concept: ideation â†’ research â†’ validated | rejected
    â”œâ”€â”€ Bug: triage â†’ investigating â†’ fixing â†’ verified
    â”‚         â†‘ PHASE IS THE STATUS - No separate status field!
    â”‚
    â””â”€â”€ TIMELINE ITEMS (MVP/SHORT/LONG breakdowns)
        â””â”€â”€ status: not_started | in_progress | blocked | completed | on_hold | cancelled
                    â†‘ Separate status for task-level execution tracking
```

**Key Clarifications**:
| Concept | Correct | Wrong |
|---------|---------|-------|
| **Phase vs Status** | Phase IS the status for work items | Separate fields |
| **Workspace Stage** | Shows DISTRIBUTION (aggregation) | Has single stage value |
| **Timeline Status** | Separate field for execution tasks | Same as work item phase |

---

## ğŸ“Š Phase System (Type-Aware)

### Type-Specific Phase Workflows

Different work item types follow different phase progressions:

**Feature/Enhancement**:
```
design â†’ build â†’ refine â†’ launch
```
| Phase | Description | Focus |
|-------|-------------|-------|
| **design** | Research, ideation, problem definition | Empathy, user needs, scope planning |
| **build** | Active development work | Building, coding, creating |
| **refine** | Testing, validation, iteration | Quality, user testing, feedback |
| **launch** | Shipped, deployed, done (TERMINAL) | Release, retrospective, metrics |

**Concept**:
```
ideation â†’ research â†’ validated | rejected
```
| Phase | Description | Terminal |
|-------|-------------|----------|
| **ideation** | Initial idea capture | No |
| **research** | Validation research | No |
| **validated** | Concept approved | Yes (promote to feature) |
| **rejected** | Concept rejected | Yes (lessons learned) |

**Bug**:
```
triage â†’ investigating â†’ fixing â†’ verified
```
| Phase | Description | Terminal |
|-------|-------------|----------|
| **triage** | Initial assessment | No |
| **investigating** | Root cause analysis | No |
| **fixing** | Active fix development | No |
| **verified** | Fix confirmed | Yes (deployed and validated) |

### Default Phases by Type

```typescript
const DEFAULT_PHASES = {
  feature: 'design',
  enhancement: 'design',
  concept: 'ideation',
  bug: 'triage'
} as const
```

### Phase Transition Requirements

**Feature/Enhancement**:
- `design â†’ build`: `purpose` filled, 1+ timeline items OR scope defined
- `build â†’ refine`: `progress_percent` >= 80, `actual_start_date` set
- `refine â†’ launch`: Feedback addressed, review approved (if enabled)

**Concept**:
- `ideation â†’ research`: `purpose` filled, hypothesis defined
- `research â†’ validated`: Research complete, viable confirmed
- `research â†’ rejected`: Research complete, not viable

**Bug**:
- `triage â†’ investigating`: Priority set, assigned
- `investigating â†’ fixing`: Root cause identified
- `fixing â†’ verified`: Fix deployed, review approved (if enabled)

---

## ğŸ’» Coding Standards

### TypeScript

- **Strict mode** enabled, NO `any` type ever
- Use **interfaces** for all data structures
- **Union types** for enums: `'design' | 'build' | 'refine' | 'launch'`
- **Explicit return types** on functions

```typescript
// âœ… GOOD
interface CreateWorkItemParams {
  name: string
  purpose: string
  type: 'feature' | 'bug' | 'concept' | 'enhancement'
  teamId: string
  workspaceId: string
}

async function createWorkItem(params: CreateWorkItemParams): Promise<WorkItem> {
  const workItem: WorkItem = {
    id: Date.now().toString(),  // Timestamp ID
    team_id: params.teamId,
    workspace_id: params.workspaceId,
    name: params.name,
    purpose: params.purpose,
    type: params.type,
    phase: DEFAULT_PHASES[params.type],
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  }
  return workItem
}

// âŒ BAD
const createWorkItem = async (data: any): any => {
  return { id: crypto.randomUUID(), ...data }
}
```

### Database Queries

**ALWAYS filter by `team_id`**:

```typescript
// âœ… GOOD - Team-scoped, error handling
const loadWorkItems = async (teamId: string, workspaceId: string) => {
  try {
    const { data, error } = await supabase
      .from('work_items')
      .select('*')
      .eq('team_id', teamId)        // REQUIRED
      .eq('workspace_id', workspaceId)
      .order('created_at', { ascending: false })

    if (error) throw error
    return data ?? []
  } catch (err) {
    console.error('Failed to load work items:', err)
    return []
  }
}

// âŒ BAD - No team_id filter, no error handling
const loadWorkItems = async () => {
  const { data } = await supabase.from('work_items').select('*')
  return data
}
```

### React/Next.js Components

- **Server Components** by default
- `'use client'` only for interactive components
- **shadcn/ui** components ONLY (no custom CSS)
- **Tailwind CSS** utility classes (no inline styles)
- **Mobile-first** responsive design

```tsx
// âœ… GOOD
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'

interface WorkItemCardProps {
  workItem: WorkItem
  onEdit: (id: string) => void
}

export function WorkItemCard({ workItem, onEdit }: WorkItemCardProps) {
  return (
    <Card className="hover:shadow-lg transition-shadow">
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle>{workItem.name}</CardTitle>
          <Badge variant={workItem.type === 'bug' ? 'destructive' : 'default'}>
            {workItem.type}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-muted-foreground">{workItem.purpose}</p>
      </CardContent>
    </Card>
  )
}

// âŒ BAD - No types, inline styles, custom CSS
const WorkItemCard = ({ item, onEdit }) => (
  <div style={{ padding: '10px', border: '1px solid #ccc' }} onClick={onEdit}>
    <span>{item.name}</span>
  </div>
)
```

---

## ğŸ”§ Tech Stack

### Framework & Database
```
Framework:    Next.js 15 + TypeScript (App Router, Server Components)
Database:     Supabase (PostgreSQL + Real-time + Auth + RLS)
UI:           shadcn/ui + Tailwind CSS + Lucide React
Mind Mapping: XYFlow/ReactFlow (custom nodes, AI-powered)
Charts:       Recharts (10+ chart types)
Testing:      Playwright (E2E)
Payments:     Stripe (Checkout, Subscriptions, Webhooks)
Email:        Resend (Invitations, notifications)
AI:           OpenRouter (Kimi K2, DeepSeek V3.2, Grok 4, Claude Haiku 4.5)
State:        Zustand + React Query
Deployment:   Vercel (Serverless functions)
```

### MCP Servers (3 Active)

**Supabase MCP** - Use for:
- Multi-tenant schema design (`teams`, `team_members`, `workspaces`, `work_items`)
- Database migrations with RLS policies
- Complex queries (joins, aggregations, transactions)
- Real-time subscriptions setup
- PostgreSQL functions and triggers
- Schema inspection and type generation

**shadcn/ui MCP** - Use for:
- Component installation from 14 registries
- Multi-registry access (origin, new-york, default, miami, etc.)
- Discovering components (1000+ available)
- Installing with proper theming

**Context7 MCP** - Use for:
- Fetching up-to-date library documentation
- Verifying API signatures and patterns
- Framework-specific best practices
- When official docs may have changed since training

**Note**: Parallel AI is a **Claude Skill**, not an MCP. Use `/parallel-ai` for web search and research.

---

## ğŸ¤– Claude Skills (Slash Commands)

### MAKER Commands (Multi-Agent Reliability)

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `/decompose` | Break task into atomic steps (MAD) | Complex features, unclear scope |
| `/validate-consensus` | K-threshold voting (2/3 approve) | Security code, 3+ file changes |
| `/red-flag-check` | Detect issues by severity | Before ANY security commit |

### Operational Commands

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `/db-migration` | Database migration workflow | Schema changes, RLS policies |
| `/security-review` | OWASP security checklist | Auth/API/payment code |
| `/tdd-feature` | Test-driven development | Critical business logic |
| `/week-update` | Progress documentation | Weekly updates |
| `/parallel-ai` | Web search, data extraction | Any research needed |

---

## ğŸ—„ï¸ Database Schema

### Core Tables

```
users           - User accounts (Supabase Auth)
teams           - Organizations/teams
team_members    - Team membership and roles
subscriptions   - Stripe billing data
workspaces      - Projects with mode and modules (within teams)
```

### Feature Tables

```
work_items      - Top-level items (features, bugs, concepts, enhancements)
timeline_items  - MVP/SHORT/LONG breakdowns
linked_items    - Dependencies and relationships
product_tasks   - Execution tasks
```

### Other Tables

```
mind_maps       - Canvas data (ReactFlow JSON)
work_flows      - Hierarchical sub-canvases
feedback        - User/stakeholder feedback
user_phase_assignments    - Phase-based permissions
phase_assignment_history  - Audit trail
phase_access_requests     - Self-service permission requests
```

### Required Fields (ALL Tables)

```sql
CREATE TABLE table_name (
  id TEXT PRIMARY KEY,                    -- Date.now().toString(), NEVER UUID
  team_id TEXT NOT NULL,                  -- CRITICAL for RLS! NEVER NULL!
  -- ... other fields ...
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

-- Create policy for team members
CREATE POLICY "table_team_access" ON table_name
FOR ALL USING (
  team_id IN (
    SELECT team_id FROM team_members
    WHERE user_id = auth.uid()
  )
);

-- Create index for performance
CREATE INDEX idx_table_team ON table_name(team_id);
```

---

## ğŸ” Security Checklist

### Before Every Commit

- [ ] All queries filter by `team_id`
- [ ] All tables have RLS enabled
- [ ] No API keys in client code
- [ ] Input validation with Zod schemas
- [ ] Error messages don't leak data
- [ ] No `any` types in TypeScript
- [ ] No UUID usage (use timestamp IDs)

### OWASP Top 10

- [ ] **A01: Broken Access Control** - RLS policies on all tables
- [ ] **A02: Cryptographic Failures** - No sensitive data in logs/URLs
- [ ] **A03: Injection** - Parameterized queries (Supabase handles)
- [ ] **A04: Insecure Design** - Auth on all protected routes
- [ ] **A05: Security Misconfiguration** - Environment variables secured
- [ ] **A06: Vulnerable Components** - Dependencies up to date
- [ ] **A07: Auth Failures** - Proper session management
- [ ] **A08: Data Integrity** - Input validation with Zod
- [ ] **A09: Security Logging** - Audit trail for sensitive ops
- [ ] **A10: SSRF** - Validate external URLs

---

## ğŸ§ª Testing Standards

### Playwright E2E Tests

Location: `next-app/e2e/`

```typescript
import { test, expect } from '@playwright/test'

test.describe('Work Items', () => {
  test.beforeEach(async ({ page }) => {
    // Login and setup
    await page.goto('/login')
    await page.fill('[name="email"]', 'test@example.com')
    await page.fill('[name="password"]', 'password')
    await page.click('button[type="submit"]')
  })

  test('should create feature with design phase', async ({ page }) => {
    await page.goto('/workspaces/test-workspace-id')
    await page.click('[data-testid="create-work-item"]')
    await page.fill('[name="name"]', 'Test Feature')
    await page.selectOption('[name="type"]', 'feature')
    await page.click('button:has-text("Create")')

    // Verify default phase for feature is 'design'
    await expect(page.locator('[data-testid="work-item-phase"]')).toContainText('design')
  })
})
```

**Test Coverage Requirements**:
- [ ] Authentication flows
- [ ] CRUD operations for all entities
- [ ] RLS policy enforcement (can't access other team's data)
- [ ] Type-aware phase transitions
- [ ] Form validation

---

## ğŸ¨ New Concepts (Post-Launch)

### Versioning System

Work items can be **enhanced** to create version chains:

```
Original Feature (v1)
    â””â”€â”€ Enhanced Feature (v2)
         â””â”€â”€ Enhanced Feature (v3)
```

**Database Fields**: `version`, `enhances_work_item_id`, `version_notes`

### Review Process

Review is **optional and detached** from phases:
- Can be enabled/disabled per work item
- Required before certain phase transitions (when enabled)
- Applies to bugs (fixing â†’ verified) and features (refine â†’ launch)

**Database Fields**: `review_enabled`, `review_status`, `review_requested_at`, `review_completed_at`, `review_reason`

### Design Thinking Methodology

Design Thinking is a **methodology/framework** for HOW to work, NOT lifecycle stages:
- AI actively suggests Design Thinking methods
- Shows guiding questions as tooltips
- References case studies for inspiration
- Maps to platform phases (Empathize/Define â†’ design, Ideate/Prototype â†’ build, Test â†’ refine)

### Strategy Alignment (Four-Tier Hierarchy)

```
ORGANIZATION STRATEGY (Pillars - Team-wide)
    â””â”€â”€ TEAM STRATEGY (Objectives - Department)
         â””â”€â”€ WORK ITEM STRATEGY (Alignment - Feature)
              â””â”€â”€ PROCESS STRATEGY (Methodology - Execution)
```

---

## ğŸ“ Documentation Rules

### Update Triggers

| Change Type | Update These Files |
|-------------|-------------------|
| **Database schema** | `CHANGELOG.md`, `database-schema.md`, regenerate types |
| **API endpoint** | `API_REFERENCE.md`, `CHANGELOG.md` |
| **Feature complete** | `week-X-Y.md`, `PROGRESS.md`, `CHANGELOG.md`, `NEXT_STEPS.md` |
| **Tech stack** | `README.md`, `CLAUDE.md`, `.cursorrules` |
| **Bug fix** | `CHANGELOG.md` only |

### File Creation Rules

| Need | Location | Convention |
|------|----------|------------|
| Migration | `supabase/migrations/` | `YYYYMMDDHHMMSS_[action]_[table].sql` |
| API route | `next-app/src/app/api/[resource]/` | `route.ts` |
| Component | `next-app/src/components/[feature]/` | `[name].tsx` (kebab-case) |
| Types | `next-app/src/lib/types/` | **EXTEND** existing file |

---

## ğŸš€ Quick Commands

### Development
```bash
npm run dev              # Start dev server (localhost:3000 ONLY)
npm run build            # Build for production
npm run lint             # Run ESLint
npx tsc --noEmit         # Type check
```

### Database
```bash
npx supabase db push                              # Apply migrations
npx supabase gen types typescript                 # Generate types
npx supabase gen types typescript > next-app/src/lib/supabase/types.ts
```

### Testing
```bash
npm run test:e2e                                  # Playwright E2E (all browsers)
npm run test:e2e:chrome                           # Chrome only
npm run test:e2e:chrome -- e2e/04-work-items.spec.ts  # Targeted test
npm run check:links                               # Validate doc links
```

---

## âš ï¸ Critical Reminders

### Always
- âœ… Timestamp IDs: `Date.now().toString()`
- âœ… Filter by `team_id` in ALL queries
- âœ… Enable RLS on ALL tables
- âœ… `team_id TEXT NOT NULL` (NULL breaks RLS silently!)
- âœ… TypeScript strict mode, no `any`
- âœ… shadcn/ui components only
- âœ… Mobile-first design
- âœ… Check Pro tier feature gates

### Never
- âŒ UUID for IDs
- âŒ Skip RLS policies
- âŒ Skip team_id filtering
- âŒ Allow NULL team_id
- âŒ Custom CSS files
- âŒ Hardcode API keys
- âŒ Use `workspace_id` for isolation (use `team_id`)
- âŒ Separate status field for work items (phase IS the status)

---

**Ready to build! ğŸš€**

See `docs/ARCHITECTURE_CONSOLIDATION.md` for complete architecture reference.
See `docs/implementation/README.md` for detailed implementation steps.
